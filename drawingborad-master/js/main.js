function autoSetSize(){function t(){let t=context.getImageData(0,0,canvas.width,canvas.height);document.documentElement.clientWidth,document.documentElement.clientHeight;canvas.width=400,canvas.height=400,context.putImageData(t,0,0)}t(),window.onresize=function(){t()}}function listenToUser(){let t=!1,e={x:undefined,y:undefined};document.body.ontouchstart!==undefined?(canvas.ontouchstart=function(n){t=!0;let a=n.touches[0].clientX,o=n.touches[0].clientY;eraserEnabled?(context.save(),context.globalCompositeOperation="destination-out",context.beginPath(),radius=lWidth/2>5?lWidth/2:5,context.arc(a,o,radius,0,2*Math.PI),context.clip(),context.clearRect(0,0,canvas.width,canvas.height),context.restore(),e={x:a,y:o}):e={x:a,y:o}},canvas.ontouchmove=function(n){let a=e.x,o=e.y,c=n.touches[0].clientX,i=n.touches[0].clientY;if(t)if(eraserEnabled)moveHandler(a,o,c,i),e.x=c,e.y=i;else{let t={x:c,y:i};drawLine(e.x,e.y,t.x,t.y),e=t}},canvas.ontouchend=function(){t=!1,canvasDraw()}):(canvas.onmousedown=function(n){t=!0;let a=n.clientX,o=n.clientY;eraserEnabled?(context.save(),context.globalCompositeOperation="destination-out",context.beginPath(),radius=lWidth/2>5?lWidth/2:5,context.arc(a,o,radius,0,2*Math.PI),context.clip(),context.clearRect(0,0,canvas.width,canvas.height),context.restore(),e={x:a,y:o}):e={x:a,y:o}},canvas.onmousemove=function(n){let a=e.x,o=e.y,c=n.clientX,i=n.clientY;if(t)if(eraserEnabled)moveHandler(a,o,c,i),e.x=c,e.y=i;else{let t={x:c,y:i};drawLine(e.x,e.y,t.x,t.y),e=t}},canvas.onmouseup=function(){t=!1,canvasDraw()})}function moveHandler(t,e,n,a){var o=radius*Math.sin(Math.atan((a-e)/(n-t))),c=radius*Math.cos(Math.atan((a-e)/(n-t))),i=t+o,s=e-c,l=t-o,r=e+c,d=n+o,u=a-c,v=n-o,h=a+c;context.save(),context.beginPath(),context.globalCompositeOperation="destination-out",radius=lWidth/2>5?lWidth/2:5,context.arc(n,a,radius,0,2*Math.PI),context.clip(),context.clearRect(0,0,canvas.width,canvas.height),context.restore(),context.save(),context.beginPath(),context.globalCompositeOperation="destination-out",context.moveTo(i,s),context.lineTo(d,u),context.lineTo(v,h),context.lineTo(l,r),context.closePath(),context.clip(),context.clearRect(0,0,canvas.width,canvas.height),context.restore()}function drawLine(t,e,n,a){context.beginPath(),context.lineWidth=lWidth,context.lineCap="round",context.lineJoin="round",context.moveTo(t,e),context.lineTo(n,a),context.stroke(),context.closePath()}function setCanvasBg(t){context.fillStyle=t,context.fillRect(0,0,canvas.width,canvas.height),context.lineWidth=1,context.strokeStyle="black",context.strokeRect(0,0,canvas.width,canvas.height)}function getColor(){for(let t=0;t<aColorBtn.length;t++)aColorBtn[t].onclick=function(){for(let t=0;t<aColorBtn.length;t++)aColorBtn[t].classList.remove("active"),this.classList.add("active"),activeColor=this.style.backgroundColor,context.fillStyle=activeColor,context.strokeStyle=activeColor;penDetail.classList.remove("active"),ifPop=!1}}function canvasDraw(){++step<canvasHistory.length&&(canvasHistory.length=step),canvasHistory.push(canvas.toDataURL()),step>0&&undo.classList.add("active")}function canvasUndo(){if(step>0){step--;let t=new Image;t.src=canvasHistory[step],t.onload=function(){context.drawImage(t,0,0)},undo.classList.add("active"),redo.classList.add("active")}else undo.classList.remove("active"),alert("\u4e0d\u80fd\u518d\u7ee7\u7eed\u64a4\u9500\u4e86")}function canvasRedo(){if(step<canvasHistory.length-1){step++;let t=new Image;t.src=canvasHistory[step],t.onload=function(){context.drawImage(t,0,0)}}else redo.classList.remove("active"),alert("\u5df2\u7ecf\u662f\u6700\u65b0\u7684\u8bb0\u5f55\u4e86")}let canvas=document.getElementById("canvas"),context=canvas.getContext("2d"),eraser=document.getElementById("eraser"),brush=document.getElementById("brush"),reSetCanvas=document.getElementById("clear"),save=document.getElementById("save"),penDetail=document.getElementById("penDetail"),aColorBtn=document.getElementsByClassName("color-item"),undo=document.getElementById("undo"),redo=document.getElementById("redo"),range1=document.getElementById("range1"),range2=document.getElementById("range2"),showOpacity=document.querySelector(".showOpacity"),closeBtn=document.querySelectorAll(".closeBtn"),eraserEnabled=!1,activeBgColor="#fff",ifPop=!1,lWidth=2,opacity=1,strokeColor="rgba(0,0,0,1)",radius=5;autoSetSize(),setCanvasBg("white"),listenToUser(),eraser.onclick=function(){eraserEnabled=!0,eraser.classList.add("active"),brush.classList.remove("active")},brush.onclick=function(){eraserEnabled=!1,brush.classList.add("active"),eraser.classList.remove("active"),ifPop?penDetail.classList.remove("active"):penDetail.classList.add("active"),ifPop=!ifPop},reSetCanvas.onclick=function(){context.clearRect(0,0,canvas.width,canvas.height),setCanvasBg("white"),canvasHistory=[],undo.classList.remove("active"),redo.classList.remove("active")},save.onclick=function(){let t=canvas.toDataURL("image/png"),e=document.createElement("a");document.body.appendChild(e),e.href=t,e.download="mypic"+(new Date).getTime(),e.target="_blank",e.click()},range1.onchange=function(){thickness.style.transform="scale("+parseInt(range1.value)+")",lWidth=parseInt(2*range1.value)},range2.onchange=function(){0!==(opacity=1-parseInt(this.value)/10)&&(showOpacity.style.opacity=opacity)},getColor();let canvasHistory=[],step=-1;undo.onclick=function(){canvasUndo()},redo.onclick=function(){canvasRedo()};for(let t=0;t<closeBtn.length;t++)closeBtn[t].onclick=function(t){t.target.parentElement.classList.remove("active")};window.onbeforeunload=function(){return"Reload site?"};